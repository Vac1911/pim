#!/usr/bin/env node

/**
 * Module dependencies.
 */

init();

/**
 * Executes a shell command and return it as a Promise.
 * @param cmd {string}
 * @return {Promise<string>}
 */
 function execCmd(cmd) {
  const exec = require("child_process").exec;
  return new Promise((resolve, reject) => {
      exec(cmd, (error, stdout, stderr) => {
          if (error) {
              console.warn(error);
          }
          resolve(stdout ? stdout : stderr);
      });
  });
}

/**
* Check if port is being used
* @param port {Number}
* @return {String|false} Get pid using the port, or false if the port is open
*/
function checkPort(port) {
  const execSync = require("child_process").execSync;
  try {
      return execSync(`lsof -t -i:${port}`).toString();
  } catch (error) {
      error.status; // Might be 127 in your example.
      error.message; // Holds the message you typically want.
      error.stderr; // Holds the stderr output. Use `.toString()`.
      error.stdout; // Holds the stdout output. Use `.toString()`.
      return false;
  }
}

/**
  * Normalize a port into a number, string, or false.
  */
 function normalizePort(val) {
  var port = parseInt(val, 10);

  if (isNaN(port)) {
      // named pipe
      return val;
  }

  if (port >= 0) {
      // port number
      return port;
  }

  return false;
}

async function init() {
  const port = normalizePort(process.env.PORT || '3001');
  const portUsedBy = checkPort(port).trim();
  let output = await execCmd(`kill -9 ${portUsedBy}`);
  console.log(`Port ${port} - Cleared`);
}